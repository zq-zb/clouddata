name: First CI/CD Pipeline # 工作流名称
# 触发条件：推送到 main 或 master 分支时自动触发，也支持手动触发
on:
  push:
    branches: ["main", "master"] # 修正缩进，移除多余数字
  workflow_dispatch: # 允许在 GitHub Actions 页面手动触发

jobs:
  # 构建作业：作为整个流程的第一步
  build-job:
    runs-on: ubuntu-latest # 运行环境：Ubuntu 最新版
    steps:
      # 必须步骤：拉取当前仓库代码（GitHub Actions 执行命令前需先获取代码）
      - name: Checkout repository code
        uses: actions/checkout@v4 # 官方拉取代码动作，v4 是稳定版
      
      # 构建脚本：输出触发者信息
      - name: Run build script
        # ${{ github.actor }} 是 GitHub 内置变量，对应触发 workflow 的用户名
        run: echo "Hello, ${{ github.actor }}! 开始构建项目..."

  # 测试作业1：依赖 build-job，与 test-job2 并行运行
  test-job1:
    needs: build-job # 依赖 build-job 成功后才执行
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4 # 测试步骤也需要拉取代码（每个 job 是独立环境）
      
      - name: Run test script
        run: echo "This job tests something (快速测试)"

  # 测试作业2：依赖 build-job，与 test-job1 并行
  test-job2:
    needs: build-job # 依赖 build-job 成功后才执行
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
      
      - name: Run longer test script
        run: |
          echo "This job tests something, but takes more time than test-job1."
          echo "After the echo commands complete, it runs the sleep command for 20 seconds"
          echo "which simulates a test that runs 20 seconds longer than test-job1"
          sleep 20 # 模拟耗时 20 秒的测试

  # 生产部署作业：需 test-job1 和 test-job2 都成功才执行
  deploy-prod:
    needs: [test-job1, test-job2] # 依赖两个测试作业，全部成功才触发
    runs-on: ubuntu-latest
    environment: production # 关联 GitHub 生产环境（需提前在仓库设置中创建该环境）
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
      
      - name: Deploy script
        # ${{ github.ref_name }} 是 GitHub 内置变量，对应触发分支名（main/master）
        run: echo "This job deploys something from the ${{ github.ref_name }} branch."
